Архитектурное предложение для аутрича ~1200 email-адресов
--------------------------------------------------------

Цель: обслуживать ~1200 адресов (несколько клиентов/направлений) с минимальными затратами и высокой отказоустойчивостью.

### Архитектура:
#### 1) Оркестратор
**Роль:** центр принятия решений — куда, когда, через кого отправлять письмо.
##### Технологии
 - Маленькая VM (2 vCPU, 2–4 GB RAM) на Hetzner/DO/Contabo
или
 - Serverless (AWS Lambda / Cloud Run / Yandex Functions)

##### Функции
 - принимает задачи на отправку писем
 - распределяет нагрузку по отправителям (мунде домены/SMTP-провайдеры)
 - управляет очередью сообщений
 - контролирует паузы, лимиты, задержки
 - принимает вебхуки (bounce/complaint) от провайдеров и обновляет статус адресов
 - выполняет health-check SMTP-серверов

##### Почему не нужен большой сервер:
1200 ящиков — это много доменов, но не много трафика.

Даже 10k писем в день легко обрабатываются на малой VM.

#### 2) Очередь (Redis)
Используется как буфер между оркестратором и воркерами-отправителями.
##### Преимущества:
 - гарантированная доставка задач (list/streams)
 - высокая скорость (до 100k msg/s)
 - авто-ретраи задач (если воркер упал)
 - горизонтальное масштабирование количества воркеров

##### Что хранится:
 - задания "отправить письмо"
 - статусы задач (pending/sent/failed)
 - лимиты на отправку (для доменов/SMTP-провайдеров)

##### Почему не RabbitMQ?
Redis проще, дешевле и стабильнее для небольшой нагрузки.

#### 3) Хранилище (PostgreSQL)
Используется как основная база.

##### Хранит:
 - список email-адресов
 - статусы (valid / soft bounce / hard bounce / complaint / paused)
 - клиентов и направления
 - шаблоны писем
 - домены и настройки отправки
 - логи отправок
 - статистику по доменам и SMTP

##### Почему PostgreSQL?
 - надёжен, хорошо работает на дешёвых VPS
 - удобен для аналитики и сложных запросов
 - много готовых инструментов для резервного копирования и мониторинга.

#### 4) SMTP-отправка
Комбинация внешних провайдеров + self-hosted решений для минимизации стоимости и повышения отказоустойчивости.

##### Пул отправителей
 1. Mailgun — хорошая доставляемость, поддержка DKIM/DMARC/Webhook.
 2. SMTP2GO / SendGrid — резервный провайдер на случай отказа основного.
 3. 1–2 VPS с Postfix — сверхдешевая отправка low-priority писем (например, follow-up).

##### Зачем такая комбинация?
 - провайдеры дают высокую доставку → для критичных писем
 - self-hosted дешевле → можно направлять до 40–60% низкоприоритетного трафика
 - при блокировке одного канала система продолжает работать

#### 5) DNS / Deliverability
##### Для каждого направления отдельный домен и поддомены вида:
 - outreach-client1.com
 - mail.client1.com
 - reply.client1.com

#####Настройки для каждого домена:
 - SPF: включает Mailgun, SendGrid, VPS
 - DKIM: ключи под каждого провайдера
 - DMARC: начиная с p=none → постепенно p=quarantine → p=reject
 - Custom Return-Path: для отслеживания bounce

##### Зачем так:
 - низкий шанс того, что блокировка одного направления затронет других клиентов
 - повышенная репутация отправителя
 - возможность быстро вводить новые домены

#### 6) Мониторинг
##### Метрики:
 - отправленные / доставленные / отклонённые
 - bounce rate, complaint rate, open rate
 - нагрузка на очереди
 - время отклика SMTP-провайдеров
 - скорость отправки писем (per domain)

##### Инструменты:
 - **Prometheus** — сбор метрик
 - **Grafana** — панели мониторинга:
    - deliverability dashboard
    - SMTP health dashboard
    - queues dashboard
 - **Alertmanager:**
    - bounce-rate > 5%
    - рост ошибок SMTP
    - падение одного из провайдеров

#### 7) Ротация:
 - Пул отправителей: provider1 / provider2 / self-hosted.
 - Round-robin с весами, с бэкофом при ошибках.
 - Warm-up для новых IP — постепенное увеличение нагрузки.

#### 8) Распределение нагрузки
Отправка выглядит так:
1. Пользователь/CRM/скрипт добавляет задание "отправить письмо" → БД.
2. Оркестратор кладёт задания в Redis.
3. Несколько воркеров (Python/Go/Node) читают задачи из очереди.
4. Каждый воркер:
   - выбирает SMTP-провайдера согласно стратегии
   - отправляет письмо
   - пишет результат в Postgres
   - отправляет метрики в Prometheus

##### Масштабирование:
 - увеличиваем/уменьшаем количество воркеров
 - Redis выдерживает высокий поток
 - SMTP-балансировка автоматически регулирует нагрузку

#### 9) Риски

| Риск                     | Решение                                         |
| ------------------------ | ----------------------------------------------- |
| Блокировка домена        | Используем поддомены, warm-up, лимиты           |
| Блокировка SMTP          | Пул провайдеров + VPS/Postfix                   |
| Скачки bounce-rate       | Автоотключение отправки + уведомления           |
| Перегрузка оркестратора  | Горизонтальное масштабирование                  |
| Потеря данных            | Авто-бэкапы PostgreSQL + репликация             |
| Репутационные блокировки | DMARC, DKIM, SPF, обратная связь с провайдерами |
| Ошибки воркеров          | Redis-ретраи + idempotency                      |

#### 10) Оценка стоимости

| Компонент                          | Стоимость |
| ---------------------------------- | --------- |
| VM оркестратора                    | $5–10     |
| Managed Redis                      | $5–10     |
| Managed PostgreSQL                 | $10–15    |
| Mailgun / SendGrid                 | $5–20     |
| 1–2 VPS для Postfix                | $10–20    |
| Мониторинг (Grafana Cloud или VPS) | $0–20     |

Итого: **$30–80** / месяц при полной отказоустойчивости.
